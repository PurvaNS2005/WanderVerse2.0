{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static '/css/my_trips.css' %}">

<div class="trips-container">
    <!-- Tabs -->
    <div class="tabs-container">
        <button class="tab-btn active" data-tab="upcoming">Upcoming Trips</button>
        <button class="tab-btn" data-tab="completed">Completed Trips</button>
    </div>

    <!-- Upcoming Trips Section -->
    <div class="trips-section active" id="upcoming-trips">
        <div class="trips-grid" id="upcoming-trips-grid">
            <!-- Trips will be loaded here dynamically -->
        </div>
    </div>

    <!-- Completed Trips Section -->
    <div class="trips-section" id="completed-trips">
        <div class="trips-grid" id="completed-trips-grid">
            <!-- Trips will be loaded here dynamically -->
        </div>
    </div>
</div>

<script>
let currentTripToDelete = null;

// Initialize Firebase
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            loadTrips();
        } else {
            window.location.href = '/login/';
        }
    });

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Show corresponding section
            document.querySelectorAll('.trips-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${button.dataset.tab}-trips`).classList.add('active');
        });
    });

    // Modal close buttons
    document.querySelectorAll('.wv-close-modal').forEach(button => {
        button.addEventListener('click', () => {
            document.getElementById('viewItineraryModal').style.display = 'none';
        });
    });
});

function loadTrips() {
    const userId = firebase.auth().currentUser.uid;
    const currentDate = new Date();

    firebase.firestore().collection('trips')
        .where('userId', '==', userId)
        .get()
        .then((querySnapshot) => {
            const upcomingTrips = [];
            const completedTrips = [];

            querySnapshot.forEach((doc) => {
                const trip = doc.data();
                trip.id = doc.id;
                const startDate = new Date(trip.startDate.toDate());

                if (startDate >= currentDate) {
                    upcomingTrips.push(trip);
                } else {
                    completedTrips.push(trip);
                }
            });

            // Sort trips by start date
            upcomingTrips.sort((a, b) => new Date(a.startDate.toDate()) - new Date(b.startDate.toDate()));
            completedTrips.sort((a, b) => new Date(b.startDate.toDate()) - new Date(a.startDate.toDate()));

            renderTrips('upcoming-trips-grid', upcomingTrips);
            renderTrips('completed-trips-grid', completedTrips);
        })
        .catch((error) => {
            console.error("Error loading trips:", error);
        });
}

function renderTrips(containerId, trips) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (trips.length === 0) {
        container.innerHTML = `
            <div class="no-trips">
                <img src="{% static 'images/no-trips.svg' %}" alt="No trips" class="no-trips-image">
                <p>No trips found</p>
            </div>
        `;
        return;
    }

    trips.forEach(trip => {
        const startDate = new Date(trip.startDate.toDate());
        const endDate = new Date(trip.endDate.toDate());
        
        const tripCard = document.createElement('div');
        tripCard.className = 'trip-card';
        tripCard.innerHTML = `
            <div class="trip-header">
                <h3>${trip.city}</h3>
                <span class="trip-dates">${formatDate(startDate)} - ${formatDate(endDate)}</span>
            </div>
            <div class="trip-actions">
                ${containerId === 'upcoming-trips-grid' ? `
                    <button class="btn-modify" onclick="modifyTrip('${trip.id}')">Modify Itinerary</button>
                    <button class="btn-view" onclick="viewItinerary('${trip.id}')">View Itinerary</button>
                    <button class="btn-delete" onclick="confirmDelete('${trip.id}')">Delete Trip</button>
                ` : `
                    <button class="btn-view" onclick="viewItinerary('${trip.id}')">View Itinerary</button>
                `}
            </div>
        `;
        container.appendChild(tripCard);
    });
}

function formatDate(date) {
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function modifyTrip(tripId) {
    window.location.href = `/trips/modify/${tripId}/`;
}

function viewItinerary(tripId) {
    window.location.href = `/trips/view_itinerary/${tripId}/`;
}

function confirmDelete(tripId) {
    if (confirm('Are you sure you want to delete this trip? This action cannot be undone.')) {
        deleteTrip(tripId);
    }
}

function deleteTrip(tripId) {
    firebase.firestore().collection('trips').doc(tripId).delete()
        .then(() => {
            console.log('Trip deleted successfully');
            loadTrips(); // Reload trips after deletion
        })
        .catch((error) => {
            console.error("Error deleting trip:", error);
        });
}
</script>
{% endblock %} 